$(function(){function a(){c.off("click"),c.remove(),h.removeClass("popup_active")}function b(b){var i=_.template(f);c=$(i({data:b?b:{activity:{},toolbox:{},brand:{},accessManagement:{},adGroups:[]}}));var j=c.find("form");b&&b.id&&j.find('[name="adGroups"]').children().each(function(){var a=$(this);_.where(b.adGroups,a.val()).length&&a.attr("selected","selected")}),c.on("click",".btn-save",function(c){c.preventDefault();var f={id:b?b.id:null,name:j.find('[name="name"]').val(),activity:{view:j.find('[name="activityView"]').is(":checked"),change:j.find('[name="activityChange"]').is(":checked"),approve:j.find('[name="activityApprove"]').is(":checked")},toolbox:{view:j.find('[name="toolboxView"]').is(":checked"),change:j.find('[name="toolboxChange"]').is(":checked"),approve:j.find('[name="toolboxApprove"]').is(":checked")},brand:{view:j.find('[name="brandView"]').is(":checked"),change:j.find('[name="brandChange"]').is(":checked"),approve:j.find('[name="brandApprove"]').is(":checked")},accessManagement:{view:j.find('[name="accessManagementView"]').is(":checked"),change:j.find('[name="accessManagementChange"]').is(":checked"),approve:j.find('[name="accessManagementApprove"]').is(":checked")},adGroups:j.find('[name="adGroups"]').val()};$.ajax({url:j.attr("action"),type:"GET",dataType:"json",data:f,success:function(c){if(a(),b&&b.id){var h=_.findIndex(accessManagementData,function(a){return a.id==b.id}),i=e.filter('[data-id="'+b.id+'"]');$.extend(accessManagementData[h],f),accessManagementData[h].adGroups=f.adGroups,i.find(".access-management-name").text(b.name),i.find(".access-management-activity-view").text(b.activity.view?"Yes":"No"),i.find(".access-management-activity-change").text(b.activity.change?"Yes":"No"),i.find(".access-management-activity-approve").text(b.activity.approve?"Yes":"No"),i.find(".access-management-ad-groups").html(b.adGroups?b.adGroups.join(", <br>"):""),i.find(".access-management-toolbox-view").text(b.toolbox.view?"Yes":"No"),i.find(".access-management-toolbox-change").text(b.toolbox.change?"Yes":"No"),i.find(".access-management-toolbox-approve").text(b.toolbox.approve?"Yes":"No"),i.find(".access-management-brand-view").text(b.brand.view?"Yes":"No"),i.find(".access-management-brand-change").text(b.brand.change?"Yes":"No"),i.find(".access-management-brand-approve").text(b.brand.approve?"Yes":"No"),i.find(".access-management-access-management-view").text(b.accessManagement.view?"Yes":"No"),i.find(".access-management-access-management-change").text(b.accessManagement.change?"Yes":"No"),i.find(".access-management-access-management-approve").text(b.accessManagement.approve?"Yes":"No")}else{f.id||(f.id=Math.random()+"");var j=_.template(g),k=j({data:c.data?c.data:f,isOdd:e.length%2==0});d.append(k),e=d.find(".access-management-item"),accessManagementData.push(c.data?c.data:f)}},error:function(a){alert("Something went wrong")}})}),c.on("click",".btn-cansel",function(b){b.preventDefault(),a()}),h.addClass("popup_active").append(c),$(".js-example-basic-multiple").select2({minimumResultsForSearch:-1,escapeMarkup:function(a){return a}}),initializeCheckboxes()}var c,d=$(".access-management-block"),e=d.find(".access-management-item"),f=$("#popup-acces-managment-tpl").html(),g=$("#popup-acces-item-tpl").html(),h=$("#popup_block");d.on("click",".btn_delete",function(a){a.preventDefault();var b=$(a.currentTarget).closest(".access-management-item"),c=b.data("id");$.ajax({url:"/request.json",type:"GET",dataType:"json",data:{id:c},success:function(){var a=_.findIndex(accessManagementData,function(a){return a.id==c});accessManagementData.splice(a,1),b.remove(),e=d.find(".access-management-item")},error:function(){alert("Something went wrong")}})}),d.on("click",".btn_edit",function(a){a.preventDefault();var c=$(a.currentTarget).closest(".access-management-item").data("id")+"",d=_.where(accessManagementData,{id:c})[0];b(d)}),$(".btn-add-role").on("click",function(a){a.preventDefault(),b()}),h.on("click","#popup_fone",function(){a()})});